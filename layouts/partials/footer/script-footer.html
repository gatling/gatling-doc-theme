{{ $indexTemplate := resources.Get "js/index.ts" }}
{{ $index := $indexTemplate | resources.ExecuteAsTemplate "index.ts" . | babel | js.Build -}}

{{ $bs := resources.Get "js/bootstrap.ts" -}}
{{ $bs := $bs | babel -}}

{{ $app := resources.Get "js/app.ts" | babel -}}
{{ $slice := slice $app -}}

{{ $clipBoard := resources.Get "js/clipboard.ts" | babel -}}
{{ $slice = $slice | append $clipBoard -}}

{{ if .Site.Params.options.lazySizes -}}
  {{ $lazySizes := resources.Get "js/lazysizes.ts" | babel -}}
  {{ $slice = $slice | append $lazySizes -}}
{{ end -}}

{{ if .Site.Params.options.instantPage -}}
  {{ $instantPage := resources.Get "js/instant.page.ts" | babel -}}
  {{ $slice = $slice | append $instantPage -}}
{{ end -}}

{{ if .Site.Params.options.flexSearch -}}
  {{ $flexSearch := resources.Get "js/vendor/flexsearch/dist/flexsearch.min.js" -}}
  {{ $flexSearchTs := slice $flexSearch | resources.Concat "flexsearch.ts" -}}
  {{ $slice = $slice | append $flexSearchTs -}}
{{ end -}}

{{ if .Site.Params.options.darkMode -}}
  {{ $darkMode := resources.Get "js/darkmode.ts" | babel -}}
  {{ $slice = $slice | append $darkMode -}}
{{ end -}}

{{ $js := $slice | resources.Concat "main.js" | js.Build -}}

{{ if eq (hugo.Environment) "development" -}}
  {{ if .Site.Params.options.bootStrapJs -}}
    <script src="{{ $bs.Permalink }}" defer></script>
  {{ end -}}
  <script src="{{ $js.Permalink }}" ></script>
  {{ if .Site.Params.options.flexSearch -}}
    <script src="{{ $index.Permalink }}" ></script>
  {{ end -}}
{{ else -}}
  {{ $js := $js | minify | fingerprint "sha512" -}}
  {{ $index := $index | minify | fingerprint "sha512" -}}
  {{ $bs := $bs | minify | fingerprint "sha512" -}}
  {{ if .Site.Params.options.bootStrapJs -}}
  <script src="{{ $bs.Permalink }}" integrity="{{ $bs.Data.Integrity }}" crossorigin="anonymous" defer></script>
  {{ end -}}
  <script src="{{ $js.Permalink }}" integrity="{{ $js.Data.Integrity }}" crossorigin="anonymous" defer></script>
  {{ if .Site.Params.options.flexSearch -}}
    <script src="{{ $index.Permalink }}" integrity="{{ $index.Data.Integrity }}" crossorigin="anonymous"></script>
  {{ end -}}
{{ end -}}
